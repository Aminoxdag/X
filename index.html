<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة الوسائط | X Media Deck</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & Lucide -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;700&display=swap');
        body { background-color: #050505; color: #e5e7eb; font-family: 'IBM Plex Sans Arabic', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Download, Plus, Copy, Trash2, X, User, Image as ImageIcon, 
            ChevronLeft, ChevronRight, RefreshCw, Video, Maximize2, 
            Clipboard, FileText, ExternalLink, Zap, Check, AlertCircle, UploadCloud, Link as LinkIcon
        } from 'lucide-react';

        // --- Lightbox ---
        const Lightbox = ({ media, onClose }) => {
            if (!media) return null;
            return (
                <div className="fixed inset-0 z-50 bg-black/98 backdrop-blur-xl flex items-center justify-center p-4 animate-[fadeIn_0.2s_ease-out]">
                    <button onClick={onClose} className="absolute top-4 right-4 text-white/70 hover:text-white bg-white/10 hover:bg-white/20 p-2 rounded-full transition-all"><X size={32} /></button>
                    <div className="w-full max-w-5xl h-full max-h-[90vh] flex items-center justify-center">
                        {media.type === 'video' ? (
                        <video src={media.url} controls autoPlay className="max-w-full max-h-full rounded-lg shadow-2xl border border-gray-800" />
                        ) : (
                        <img src={media.url} alt="Full view" className="max-w-full max-h-full object-contain rounded-lg shadow-2xl border border-gray-800" />
                        )}
                    </div>
                </div>
            );
        };

        // --- Tweet Card ---
        const TweetCard = ({ tweet, onRemove, onOpenLightbox }) => {
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isCopying, setIsCopying] = useState(false);
            const [isCatboxCopying, setIsCatboxCopying] = useState(false);
            const [isUploading, setIsUploading] = useState(false);
            const [catboxUrl, setCatboxUrl] = useState(null);
            const [uploadProgress, setUploadProgress] = useState(0); // 0=idle, 1=downloading, 2=uploading
            
            const currentMedia = tweet.media[currentIndex];

            // Reset upload state when slide changes
            useEffect(() => {
                setIsUploading(false);
                setCatboxUrl(null);
                setUploadProgress(0);
            }, [currentIndex]);

            const nextSlide = (e) => { e.stopPropagation(); setCurrentIndex((prev) => (prev === tweet.media.length - 1 ? 0 : prev + 1)); };
            const prevSlide = (e) => { e.stopPropagation(); setCurrentIndex((prev) => (prev === 0 ? tweet.media.length - 1 : prev - 1)); };

            const downloadCurrent = async (e) => {
                e.stopPropagation();
                const item = currentMedia;
                const filename = `${tweet.handle}_${tweet.id}_${currentIndex}.${item.type === 'video' ? 'mp4' : 'jpg'}`;
                try {
                    const response = await fetch(item.url);
                    if (!response.ok) throw new Error('CORS');
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url; link.download = filename;
                    document.body.appendChild(link); link.click();
                    document.body.removeChild(link); window.URL.revokeObjectURL(url);
                } catch (e) { window.open(item.url, '_blank'); }
            };

            // --- دالة الرفع المحسنة ---
            const uploadToCatbox = async (e) => {
                e.stopPropagation();
                if (isUploading || catboxUrl) return;

                setIsUploading(true);
                setUploadProgress(1); // مرحلة تحميل الملف محلياً
                
                try {
                    // 1. تحميل الفيديو كـ Blob محلياً أولاً
                    const fileResponse = await fetch(currentMedia.url);
                    if (!fileResponse.ok) throw new Error('فشل تحميل الملف الأصلي');
                    const blob = await fileResponse.blob();

                    setUploadProgress(2); // مرحلة الرفع

                    // 2. تجهيز البيانات
                    const formData = new FormData();
                    formData.append('reqtype', 'fileupload');
                    const filename = `x_deck_${tweet.id}_${Date.now()}.mp4`;
                    const file = new File([blob], filename, { type: 'video/mp4' });
                    formData.append('fileToUpload', file);

                    // 3. محاولة الرفع عبر عدة وسطاء (Proxies) لتفادي الحظر
                    const targetUrl = 'https://catbox.moe/user/api.php';
                    
                    // قائمة الوسطاء - اذا فشل الاول يجرب الثاني
                    const proxies = [
                        // الوسيط الأول: ThingProxy (يعمل جيداً مع POST)
                        { url: (target) => `https://thingproxy.freeboard.io/fetch/${target}` },
                        // الوسيط الثاني: CorsProxy (القديم - كاحتياط)
                        { url: (target) => `https://corsproxy.io/?${encodeURIComponent(target)}` }
                    ];

                    let resultUrl = null;
                    let lastError = null;

                    for (const proxy of proxies) {
                        try {
                            const proxyUrl = proxy.url(targetUrl);
                            console.log("Trying proxy:", proxyUrl); // Debugging

                            const response = await fetch(proxyUrl, {
                                method: 'POST',
                                body: formData
                            });

                            if (response.ok) {
                                const text = await response.text();
                                if (text && text.startsWith('http')) {
                                    resultUrl = text;
                                    break; // نجح الرفع، نخرج من الحلقة
                                }
                            }
                        } catch (err) {
                            console.warn("Proxy failed, trying next...", err);
                            lastError = err;
                        }
                    }

                    if (resultUrl) {
                        setCatboxUrl(resultUrl);
                    } else {
                        throw new Error('فشل الرفع عبر جميع الوسطاء. قد يكون خادم Catbox محظوراً مؤقتاً.');
                    }

                } catch (err) {
                    console.error(err);
                    alert(`فشل الرفع: ${err.message}\nجرب مرة أخرى لاحقاً.`);
                } finally {
                    setIsUploading(false);
                    setUploadProgress(0);
                }
            };

            const copyText = (textToCopy, type = 'link') => {
                if (!textToCopy) return;
                
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                textArea.style.position = "fixed"; textArea.style.left = "-9999px";
                document.body.appendChild(textArea); textArea.focus(); textArea.select();
                document.execCommand('copy'); document.body.removeChild(textArea);
                
                if (type === 'link') {
                    setIsCopying(true); setTimeout(() => setIsCopying(false), 1500);
                } else if (type === 'catbox') {
                    setIsCatboxCopying(true); setTimeout(() => setIsCatboxCopying(false), 1500);
                } else {
                    const btn = document.getElementById(`text-copy-${tweet.id}`);
                    if(btn) { btn.style.color = '#4ade80'; setTimeout(() => btn.style.color = '', 500); }
                }
            };

            return (
                <div className="bg-[#111111] border border-[#222] rounded-3xl overflow-hidden shadow-2xl hover:border-gray-700 transition-all duration-300 group relative flex flex-col h-full">
                    {/* Header */}
                    <div className="p-4 flex items-center justify-between bg-[#161616] border-b border-[#222]">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full p-[1px] bg-gray-700 overflow-hidden">
                                {tweet.avatar ? <img src={tweet.avatar} className="w-full h-full object-cover" /> : <User size={20} className="text-gray-400 m-auto" />}
                            </div>
                            <div className="flex flex-col">
                                <span className="font-bold text-sm text-gray-200 leading-tight">{tweet.author}</span>
                                <span className="text-xs text-gray-500 font-mono">@{tweet.handle}</span>
                            </div>
                        </div>
                        <button onClick={() => onRemove(tweet.id)} className="text-gray-600 hover:text-red-500 p-2 rounded-full hover:bg-red-500/10"><Trash2 size={18} /></button>
                    </div>

                    {/* Media Viewer */}
                    <div className="relative aspect-[4/3] bg-black cursor-zoom-in overflow-hidden border-b border-[#222]" onClick={() => onOpenLightbox(currentMedia)}>
                        <div className="w-full h-full flex items-center justify-center bg-black">
                            {currentMedia.type === 'video' ? (
                            <video src={currentMedia.url} className="w-full h-full object-contain" poster={currentMedia.thumb} controls onClick={(e) => e.stopPropagation()} />
                            ) : (
                            <img src={currentMedia.url} className="w-full h-full object-contain" />
                            )}
                        </div>
                        {tweet.media.length > 1 && (
                        <>
                            <button onClick={prevSlide} className="absolute left-3 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/80 text-white p-2 rounded-full backdrop-blur-md opacity-0 group-hover:opacity-100 transition-all"><ChevronLeft size={20} /></button>
                            <button onClick={nextSlide} className="absolute right-3 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/80 text-white p-2 rounded-full backdrop-blur-md opacity-0 group-hover:opacity-100 transition-all"><ChevronRight size={20} /></button>
                            <div className="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-1.5 z-10 px-3 py-1.5 rounded-full bg-black/60 backdrop-blur-md border border-white/5">
                            {tweet.media.map((_, idx) => (<div key={idx} className={`h-1.5 rounded-full transition-all duration-300 ${idx === currentIndex ? 'bg-white w-6' : 'bg-white/30 w-1.5'}`} />))}
                            </div>
                        </>
                        )}
                        <div className="absolute top-3 right-3 bg-black/70 backdrop-blur-md px-2 py-1 rounded-lg text-[10px] font-bold uppercase flex items-center gap-1 border border-white/10 text-gray-200">
                            {currentMedia.type === 'video' ? <Video size={10} /> : <ImageIcon size={10} />} <span>{currentIndex + 1}/{tweet.media.length}</span>
                        </div>
                    </div>

                    {/* Tweet Text */}
                    {tweet.text && <div className="px-5 py-4 bg-[#111] text-right border-b border-[#222] flex-1"><p className="text-sm text-gray-300 leading-7 whitespace-pre-wrap" dir="auto">{tweet.text}</p></div>}

                    {/* Action Footer */}
                    <div className="p-3 bg-[#161616] mt-auto flex flex-wrap gap-2 items-center">
                        {/* Download Button */}
                        <button onClick={downloadCurrent} className="flex-1 bg-[#222] hover:bg-[#333] text-gray-200 py-2.5 px-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 transition-all border border-[#333] min-w-[80px]">
                            <Download size={14} /> <span className="hidden sm:inline">تحميل</span>
                        </button>

                        {/* Catbox Upload / Result Area */}
                        {currentMedia.type === 'video' ? (
                            catboxUrl ? (
                                <div className="flex-[2] flex items-center gap-2 bg-[#1a1a1a] border border-blue-900/50 rounded-xl p-1 animate-[fadeIn_0.3s_ease-out]">
                                    <div className="bg-blue-900/20 p-1.5 rounded-lg text-blue-400">
                                        <LinkIcon size={14} />
                                    </div>
                                    <input 
                                        type="text" 
                                        value={catboxUrl} 
                                        readOnly 
                                        className="bg-transparent text-blue-100 text-[10px] sm:text-xs px-1 w-full outline-none font-mono dir-ltr text-left truncate"
                                        onClick={(e) => e.target.select()}
                                    />
                                    <button 
                                        onClick={() => copyText(catboxUrl, 'catbox')}
                                        className={`p-1.5 rounded-lg transition-all flex-shrink-0 ${isCatboxCopying ? 'bg-green-500 text-white' : 'bg-[#333] text-gray-400 hover:text-white'}`}
                                        title="نسخ الرابط"
                                    >
                                        {isCatboxCopying ? <Check size={14} /> : <Copy size={14} />}
                                    </button>
                                </div>
                            ) : (
                                <button 
                                    onClick={uploadToCatbox} 
                                    disabled={isUploading}
                                    className="flex-1 bg-[#222] hover:bg-[#333] text-gray-200 py-2.5 px-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 transition-all border border-[#333] min-w-[100px]"
                                >
                                    {isUploading ? (
                                        <RefreshCw size={14} className="animate-spin" />
                                    ) : (
                                        <UploadCloud size={14} />
                                    )}
                                    <span>
                                        {isUploading 
                                            ? (uploadProgress === 1 ? 'جاري التحضير...' : 'جاري الرفع...') 
                                            : 'رفع Catbox'}
                                    </span>
                                </button>
                            )
                        ) : null}

                        {/* Copy Link Button */}
                        <button onClick={() => copyText(currentMedia.url, 'link')} className={`${isCopying ? 'bg-green-900/20 text-green-400 border-green-900/50' : 'bg-[#222] text-gray-400 hover:bg-[#333] border-[#333]'} flex-1 border py-2.5 px-3 rounded-xl text-xs font-medium flex items-center justify-center gap-2 transition-all min-w-[80px]`}>
                            {isCopying ? <Check size={14} /> : <Copy size={14} />} <span className="hidden sm:inline">{isCopying ? 'منسوخ' : 'رابط'}</span>
                        </button>

                        {/* Copy Text Button */}
                        <button id={`text-copy-${tweet.id}`} onClick={() => copyText(tweet.text, 'text')} className="bg-[#222] text-gray-500 hover:text-white hover:bg-[#333] border border-[#333] w-10 h-10 rounded-xl flex items-center justify-center transition-all flex-shrink-0" title="نسخ النص">
                            <FileText size={14} />
                        </button>
                    </div>
                </div>
            );
        };

        // --- APP ---
        const App = () => {
            const [input, setInput] = useState('');
            const [tweets, setTweets] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [lightboxMedia, setLightboxMedia] = useState(null);
            const inputRef = useRef(null);

            useEffect(() => {
                const saved = localStorage.getItem('x-media-deck-data');
                if (saved) { try { setTweets(JSON.parse(saved)); } catch (e) {} }
            }, []);

            useEffect(() => { localStorage.setItem('x-media-deck-data', JSON.stringify(tweets)); }, [tweets]);

            const extractTweetId = (urlInput) => {
                try {
                    let safeUrl = urlInput.trim();
                    if (!safeUrl.startsWith('http')) {
                        safeUrl = `https://${safeUrl}`;
                    }
                    
                    const urlObj = new URL(safeUrl);
                    if (urlObj.hostname.includes('twitter.com') || urlObj.hostname.includes('x.com')) {
                        const pathSegments = urlObj.pathname.split('/');
                        const statusIndex = pathSegments.indexOf('status');
                        if (statusIndex !== -1 && pathSegments[statusIndex + 1]) return pathSegments[statusIndex + 1];
                    }
                    return null;
                } catch (e) { return null; }
            };

            const fetchTweetData = async (id) => {
                try {
                    const response = await fetch(`https://api.fxtwitter.com/status/${id}`);
                    if (!response.ok) throw new Error('Network error');
                    const data = await response.json();
                    const mediaList = [];
                    if (data?.tweet?.media?.videos) data.tweet.media.videos.forEach(v => mediaList.push({ type: 'video', url: v.url, thumb: v.thumbnail_url }));
                    if (data?.tweet?.media?.photos) {
                        const hasVideo = mediaList.some(m => m.type === 'video');
                        if (!hasVideo || mediaList.length === 0) data.tweet.media.photos.forEach(p => mediaList.push({ type: 'image', url: p.url, thumb: p.url }));
                    }
                    if (mediaList.length === 0) return null;
                    return {
                        id: id, text: data.tweet.text, author: data.tweet.author.name, handle: data.tweet.author.screen_name,
                        avatar: data.tweet.author.avatar_url, media: mediaList, timestamp: Date.now()
                    };
                } catch (error) { return null; }
            };

            const handlePaste = async () => {
                try { const text = await navigator.clipboard.readText(); setInput(text); } catch (err) { alert("الصق الرابط يدوياً"); }
            };

            const handleAddLink = async () => {
                setIsProcessing(true);
                
                const regex = /((https?:\/\/)?(www\.)?(twitter\.com|x\.com)\/[a-zA-Z0-9_]+\/status\/[0-9]+)/g;
                const rawMatches = input.match(regex) || [];
                
                if (rawMatches.length === 0) {
                    alert("لم يتم العثور على رابط صحيح! تأكد أن الرابط يحتوي على x.com أو twitter.com ورقم التغريدة.");
                    setIsProcessing(false);
                    return;
                }

                const newTweets = [];
                const uniqueUrls = [...new Set(rawMatches)];

                for (const url of uniqueUrls) {
                    const id = extractTweetId(url);
                    if (id && !tweets.some(t => t.id === id)) {
                        const tweetData = await fetchTweetData(id);
                        if (tweetData) newTweets.push(tweetData);
                    }
                }

                setTweets(prev => [...newTweets, ...prev]);
                setInput('');
                setIsProcessing(false);
            };

            const removeTweet = (id) => setTweets(prev => prev.filter(t => t.id !== id));
            const clearAll = () => { if(window.confirm("هل أنت متأكد؟")) setTweets([]); };

            return (
                <div className="min-h-screen flex flex-col items-center p-4 sm:p-8 overflow-x-hidden">
                    {lightboxMedia && <Lightbox media={lightboxMedia} onClose={() => setLightboxMedia(null)} />}

                    <header className="w-full max-w-5xl flex justify-between items-center mb-10 z-10">
                        <div className="flex items-center gap-4">
                            <div className="bg-[#111] border border-[#333] text-white p-3 rounded-2xl shadow-xl"><X size={24} strokeWidth={3} /></div>
                            <div><h1 className="text-2xl font-bold text-white">منصة الوسائط</h1><p className="text-xs text-gray-600">Catbox Fixed (Proxy Rotation)</p></div>
                        </div>
                        {tweets.length > 0 && <button onClick={clearAll} className="bg-[#111] border border-[#333] text-gray-400 hover:text-red-400 px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2"><Trash2 size={14} /> تنظيف</button>}
                    </header>

                    <main className="w-full max-w-5xl space-y-8 z-10">
                        <div className="bg-[#111] border border-[#333] rounded-3xl p-2 pl-3 flex gap-2 shadow-lg">
                            <button onClick={handlePaste} className="sm:hidden bg-[#222] text-gray-300 p-3 rounded-xl hover:bg-[#333]"><Clipboard size={20} /></button>
                            <input 
                                ref={inputRef} type="text" value={input} onChange={(e) => setInput(e.target.value)} 
                                onKeyDown={(e) => e.key === 'Enter' && handleAddLink()} 
                                placeholder="الصق رابط التغريدة هنا (x.com/...)" 
                                className="flex-1 bg-transparent border-none text-gray-200 px-3 py-3 focus:ring-0 placeholder-gray-700 text-sm font-medium dir-rtl text-right outline-none truncate" 
                            />
                            <button onClick={handleAddLink} disabled={isProcessing || !input.trim()} className={`px-6 rounded-2xl font-bold text-sm flex items-center gap-2 transition-all ${isProcessing ? 'bg-[#222] text-gray-500' : 'bg-white text-black hover:bg-gray-200'}`}>
                                {isProcessing ? <RefreshCw className="animate-spin" size={20} /> : <Plus size={20} />} <span className="hidden sm:inline">إضافة</span>
                            </button>
                        </div>

                        {tweets.length > 0 && <div className="flex justify-between px-4 text-xs text-gray-600"><span>البطاقات: {tweets.length}</span><span className="flex gap-1"><Zap size={12} /> تلقائي</span></div>}
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 pb-20">
                            {tweets.map((tweet) => <TweetCard key={tweet.id} tweet={tweet} onRemove={removeTweet} onOpenLightbox={setLightboxMedia} />)}
                        </div>

                        {tweets.length === 0 && !isProcessing && (
                            <div className="text-center py-24 opacity-30 flex flex-col items-center">
                                <ExternalLink size={40} className="text-gray-500 mb-4" />
                                <h3 className="text-xl font-bold text-gray-300">لا توجد بطاقات</h3>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
